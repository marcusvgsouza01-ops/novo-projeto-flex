<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grupo ST Comunicaçao Integrada</title>
  
  <link href="[https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css](https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css)" rel="stylesheet">
  <link rel="stylesheet" href="[https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css](https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css)">
  
  <script>
    const userRole = sessionStorage.getItem('userRole');
    if (userRole !== 'admin') {
        window.location.href = 'login.html';
    }
  </script>

  <style>
    :root {
      --cor-fundo: #2c3e50;
      --cor-card: #34495e;
      --cor-borda: #46607a;
      --cor-texto: #ecf0f1;
      --cor-destaque: #3498db;
      --cor-sucesso: #2ecc71;
      --cor-aviso: #f1c40f;
      --cor-perigo: #e74c4c;
    }
    body {
      background-color: var(--cor-fundo);
      color: var(--cor-texto);
    }
    .card {
      background-color: var(--cor-card);
      border: 1px solid var(--cor-borda);
    }
    .card-title, .form-label, .table-dark thead th {
      color: var(--cor-texto) !important;
    }
    .form-control, .form-select {
      background-color: var(--cor-card);
      border: 1px solid var(--cor-borda);
      color: var(--cor-texto);
    }
    .form-control::placeholder {
      color: #bdc3c7;
    }
    .table-dark thead th {
      background-color: var(--cor-card);
      border-color: var(--cor-borda);
    }
    .table-dark tbody tr {
      border-color: var(--cor-borda);
    }
    .nav-tabs .nav-link {
      color: var(--cor-texto);
      border: 1px solid transparent;
      border-bottom: 1px solid var(--cor-borda);
      background-color: var(--cor-fundo);
    }
    .nav-tabs .nav-link.active {
      background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
      color: var(--cor-destaque);
      border-color: var(--cor-borda);
      border-bottom-color: transparent;
    }
    .btn-primary {
      background-color: var(--cor-destaque);
      border-color: var(--cor-destaque);
    }
    .btn-primary:hover {
      background-color: #2980b9;
      border-color: #2980b9;
    }
    .concluida {
      text-decoration: line-through;
      color: #95a5a6 !important;
    }
    .badge-prioridade-baixa { background-color: var(--cor-sucesso); }
    .badge-prioridade-media { background-color: var(--cor-aviso); color: #000; }
    .badge-prioridade-alta { background-color: var(--cor-perigo); }
    .navbar {
      background-color: var(--cor-card);
      border-bottom: 1px solid var(--cor-borda);
    }
    .navbar-brand {
      color: var(--cor-texto) !important;
    }
    .btn-outline-secondary {
      color: var(--cor-texto);
      border-color: var(--cor-borda);
    }
    .btn-outline-danger {
      color: var(--cor-perigo);
      border-color: var(--cor-perigo);
    }
    .btn-outline-success {
      color: var(--cor-sucesso);
      border-color: var(--cor-sucesso);
    }
    #userIdDisplay {
        font-size: 0.8rem;
        color: #7f8c8d;
        word-break: break-all;
    }
    .text-center-btn {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
        margin-bottom: 1rem;
    }
    .objetivo-item {
        margin-bottom: 1.5rem;
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid var(--cor-borda);
        background-color: #46607a;
    }
    .objetivo-item h6 {
      color: var(--cor-destaque);
    }
    .objetivo-item p {
      margin-bottom: 0.5rem;
    }
    .objetivo-item.concluido {
      opacity: 0.6;
      text-decoration: line-through;
    }
    .notification-banner {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        min-width: 250px;
        background-color: var(--cor-destaque);
        color: var(--cor-texto);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        display: none;
        animation: fadeInOut 5s forwards;
    }
    @keyframes fadeInOut {
        0% { opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { opacity: 0; display: none; }
    }
  </style>
</head>
<body>
  
  <div class="container mt-4">
    <div class="card p-4">
      <div class="d-flex justify-content-center align-items-center mb-4">
        <img src="/images/image_64f7fe.png" alt="Logo da Empresa" style="max-height: 120px;">
      </div>
      <h1 class="card-title text-center p-3">Grupo ST Comunicaçao Integrada</h1>

      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="objetivos-tab" data-bs-toggle="tab" href="#objetivos" role="tab" aria-controls="objetivos" aria-selected="true">Objetivos</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="almoxarifado-tab" data-bs-toggle="tab" href="#almoxarifado" role="tab" aria-controls="almoxarifado" aria-selected="false">Almoxarifado</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="pcp-tab" data-bs-toggle="tab" href="#pcp" role="tab" aria-controls="pcp" aria-selected="false">PCP</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="producao-tab" data-bs-toggle="tab" href="#producao" role="tab" aria-controls="producao" aria-selected="false">Produção</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="expedicao-tab" data-bs-toggle="tab" href="#expedicao" role="tab" aria-controls="expedicao" aria-selected="false">Expedição</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="tarefas-tab" data-bs-toggle="tab" href="#tarefas" role="tab" aria-controls="tarefas" aria-selected="false">Tarefas</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="ordem-servico-tab" data-bs-toggle="tab" href="#ordem-servico" role="tab" aria-controls="ordem-servico" aria-selected="false">O.S</a>
        </li>
      </ul>

      <div class="tab-content mt-3" id="myTabContent">
        <div class="tab-pane fade show active" id="objetivos" role="tabpanel" aria-labelledby="objetivos-tab">
            <!-- UI para escolher o tipo de objetivo -->
            <div id="objetivo-selector" class="text-center mb-4">
                <h5 class="text-white">Escolha o tipo de Objetivo a ser definido:</h5>
                <button id="btn-objetivo-os" class="btn btn-primary me-2">Objetivo de O.S.</button>
                <button id="btn-objetivo-produtividade" class="btn btn-primary">Objetivo de Produtividade</button>
            </div>
            
            <!-- Formulário Objetivo de O.S. (invisível por padrão) -->
            <form id="form-objetivo-os" class="mb-3 d-none">
                <h5 class="text-white mb-3">Definir Objetivo de O.S.</h5>
                <div class="mb-3">
                    <label for="numero_os_obj" class="form-label">Número de O.S.</label>
                    <input type="text" class="form-control" id="numero_os_obj" required>
                </div>
                <div class="mb-3">
                    <label for="cliente_obj" class="form-label">Nome do Cliente</label>
                    <input type="text" class="form-control" id="cliente_obj" required>
                </div>
                <div class="mb-3">
                    <label for="data_entrega_setor_obj" class="form-label">Data para Entrega de Cada Setor</label>
                    <input type="datetime-local" class="form-control" id="data_entrega_setor_obj">
                </div>
                <div class="mb-3">
                    <label for="data_final_embalar_obj" class="form-label">Data Final para Estar Embalada</label>
                    <input type="datetime-local" class="form-control" id="data_final_embalar_obj">
                </div>
                <button type="submit" class="btn btn-success w-100">Salvar Objetivo de O.S.</button>
                <button type="button" class="btn btn-secondary w-100 mt-2" id="back-to-selector">Voltar</button>
                <p id="status-objetivo-os" class="mt-2 text-center text-white"></p>
            </form>

            <!-- Formulário Objetivo de Produtividade (invisível por padrão) -->
            <form id="form-objetivo-produtividade" class="mb-3 d-none">
                <h5 class="text-white mb-3">Definir Objetivo de Produtividade</h5>
                <div class="mb-3">
                    <label for="setores_envolvidos_obj" class="form-label">Setores Envolvidos</label>
                    <input type="text" class="form-control" id="setores_envolvidos_obj" placeholder="Ex: Produção, Expedição" required>
                </div>
                <div class="mb-3">
                    <label for="meta_pedidos_obj" class="form-label">Meta de Pedidos</label>
                    <input type="number" class="form-control" id="meta_pedidos_obj" required>
                </div>
                <div class="mb-3">
                    <label for="tempo_entrega_setor_obj" class="form-label">Tempo de Entrega por Setor (horas)</label>
                    <input type="number" class="form-control" id="tempo_entrega_setor_obj">
                </div>
                <div class="mb-3">
                    <label for="tempo_final_embalar_obj" class="form-label">Tempo Final para Embalar (horas)</label>
                    <input type="number" class="form-control" id="tempo_final_embalar_obj">
                </div>
                <button type="submit" class="btn btn-success w-100">Salvar Objetivo de Produtividade</button>
                <button type="button" class="btn btn-secondary w-100 mt-2" id="back-to-selector2">Voltar</button>
                <p id="status-objetivo-prod" class="mt-2 text-center text-white"></p>
            </form>

            <hr class="border-secondary my-4">
            
            <!-- Lista de Objetivos Pendentes (visível para todos) -->
            <h5 class="text-white">Objetivos Pendentes</h5>
            <div id="lista-objetivos-pendentes" class="mt-3">
                <p class="text-white-50">Nenhum objetivo pendente.</p>
            </div>
            
            <h5 class="text-white mt-4">Objetivos Concluídos</h5>
            <div id="lista-objetivos-concluidos" class="mt-3">
                 <p class="text-white-50">Nenhum objetivo concluído.</p>
            </div>
        </div>
        <div class="tab-pane fade" id="almoxarifado" role="tabpanel" aria-labelledby="almoxarifado-tab">
            <h5 class="text-white">Conteúdo do Módulo de Almoxarifado</h5>
            <p>Este módulo agora está em um arquivo separado para melhor organização.</p>
        </div>
        <div class="tab-pane fade" id="pcp" role="tabpanel" aria-labelledby="pcp-tab">
            <h5 class="text-white">Conteúdo do Módulo de PCP</h5>
            <p>Este módulo agora está em um arquivo separado para melhor organização.</p>
        </div>
        <div class="tab-pane fade" id="producao" role="tabpanel" aria-labelledby="producao-tab">
            <h5 class="text-white">Conteúdo do Módulo de Produção</h5>
            <p>Este módulo agora está em um arquivo separado para melhor organização.</p>
        </div>
        <div class="tab-pane fade" id="expedicao" role="tabpanel" aria-labelledby="expedicao-tab">
            <h5 class="text-white">Conteúdo do Módulo de Expedição</h5>
            <p>Acompanhamento dos pedidos para envio.</p>
        </div>
        <div class="tab-pane fade" id="tarefas" role="tabpanel" aria-labelledby="tarefas-tab">
          <form id="task-form" class="mb-3">
            <div class="mb-3">
              <label for="titulo" class="form-label">Título da Tarefa</label>
              <input type="text" class="form-control" id="titulo" required>
            </div>
            <div class="mb-3">
              <label for="quando" class="form-label">Quando</label>
              <input type="datetime-local" class="form-control" id="quando">
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="antecedencia" class="form-label">Notificar com (minutos)</label>
                <input type="number" class="form-control" id="antecedencia" value="0">
              </div>
              <div class="col-md-6 mb-3">
                <label for="prioridade" class="form-label">Prioridade</label>
                <select class="form-select" id="prioridade">
                  <option value="baixa">Baixa</option>
                  <option value="media" selected>Média</option>
                  <option value="alta">Alta</option>
                </select>
              </div>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="notificar">
              <label class="form-check-label" for="notificar">Habilitar Notificação</label>
            </div>
            <button type="submit" class="btn btn-primary w-100">Salvar Tarefa</button>
            <p id="status-area-task" class="mt-2 text-center text-white"></p>
          </form>
          <div class="input-group mb-3">
            <span class="input-group-text bg-dark border-secondary text-white"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="buscar-tarefas" placeholder="Buscar tarefas...">
          </div>
          <h5 class="text-white">Tarefas Pendentes</h5>
          <div class="table-responsive">
            <table class="table table-dark table-hover table-sm">
              <thead>
                <tr>
                  <th>Título</th>
                  <th>Quando</th>
                  <th>Prioridade</th>
                  <th>Ações</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="lista-tarefas">
              </tbody>
            </table>
          </div>
          <h5 class="text-white mt-4">Tarefas Concluídas</h5>
          <div class="table-responsive">
            <table class="table table-dark table-hover table-sm">
              <thead>
                <tr>
                  <th>Título</th>
                  <th>Quando</th>
                  <th>Prioridade</th>
                  <th>Ações</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="lista-tarefas-concluidas">
              </tbody>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="ordem-servico" role="tabpanel" aria-labelledby="ordem-servico-tab">
            <div class="input-group mb-3">
                <span class="input-group-text bg-dark border-secondary text-white"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" id="buscar-os" placeholder="Buscar O.S. por número...">
            </div>
            <form id="os-form" class="mb-3">
                <div class="mb-3">
                    <label for="numero_os" class="form-label">Número da O.S.</label>
                    <input type="text" class="form-control" id="numero_os" required>
                </div>
                <div class="mb-3">
                    <label for="cliente" class="form-label">Cliente</label>
                    <input type="text" class="form-control" id="cliente" required>
                </div>
                <div class="mb-3">
                    <label for="tecnico" class="form-label">Técnico</label>
                    <input type="text" class="form-control" id="tecnico">
                </div>
                <div class="mb-3">
                    <label for="descricao_os" class="form-label">Descrição</label>
                    <textarea class="form-control" id="descricao_os" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100">Salvar O.S.</button>
                <p id="status-area-os" class="mt-2 text-center text-white"></p>
            </form>
            <div class="table-responsive">
              <table class="table table-dark table-hover table-sm">
                <thead>
                  <tr>
                    <th>O.S.</th>
                    <th>Cliente</th>
                    <th>Técnico</th>
                    <th>Status</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="lista-os">
                </tbody>
              </table>
            </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="text-center-btn">
    <button id="switch-account-btn" class="btn btn-outline-danger w-50">
        <i class="bi bi-person-fill-gear"></i> Trocar de Conta
    </button>
  </div>
  
  <!-- Modal de Notificação -->
  <div id="notification-banner" class="notification-banner"></div>

  <script src="[https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js](https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js)"></script>

  <!-- Firebase Scripts -->
  <script type="module">
    import { initializeApp } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js)";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js)";
    import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js)";
    import { setLogLevel } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js)";
    
    setLogLevel('debug');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db;
    let auth;
    let userId = null;

    function el(sel) { return document.querySelector(sel); }
    const notificationBanner = el('#notification-banner');

    let tarefas = [];
    let osList = [];
    let objetivos = [];
    
    function formatDate(timestamp) {
      if (!timestamp) return '';
      const d = timestamp.toDate();
      return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function showNotification(message) {
        notificationBanner.textContent = message;
        notificationBanner.style.display = 'block';
        setTimeout(() => {
            notificationBanner.style.display = 'none';
        }, 5000); // Esconde a notificação após 5 segundos
    }

    function renderTasksTable(tbodySel, list) {
        const tbody = el(tbodySel);
        tbody.innerHTML = '';
        if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-white text-center">Sem tarefas.</td></tr>';
            return;
        }
        list.forEach(t => {
            const tr = document.createElement('tr');
            
            let prioridadeBadgeClass = 'badge bg-secondary';
            if (t.prioridade === 'baixa') {
                prioridadeBadgeClass = 'badge badge-prioridade-baixa';
            } else if (t.prioridade === 'media') {
                prioridadeBadgeClass = 'badge badge-prioridade-media';
            } else if (t.prioridade === 'alta') {
                prioridadeBadgeClass = 'badge badge-prioridade-alta';
            }
            const concluidaClass = t.concluida ? 'concluida' : '';

            tr.innerHTML = `
                <td class="${concluidaClass}">${t.titulo}</td>
                <td class="${concluidaClass}">${t.quando ? formatDate(t.quando) : 'N/A'}</td>
                <td><span class="${prioridadeBadgeClass}">${t.prioridade}</span></td>
                <td>
                    <button class="btn btn-sm btn-link text-white text-decoration-none" data-id="${t.id}" data-action="toggle-concluida">
                        ${t.concluida ? 'Reabrir' : 'Concluir'}
                    </button>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary" data-id="${t.id}" data-action="editar-task"><i class="bi bi-pencil-square"></i></button>
                    <button class="btn btn-sm btn-outline-danger" data-id="${t.id}" data-action="excluir-task"><i class="bi bi-trash3-fill"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderOSTable(tbodySel, list) {
        const tbody = el(tbodySel);
        tbody.innerHTML = '';
        if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-white text-center">Sem O.S. Liberadas.</td></tr>';
            return;
        }
        list.forEach(os => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${os.numero_os}</td>
                <td>${os.cliente}</td>
                <td>${os.tecnico || 'N/A'}</td>
                <td>${os.status}</td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary" data-id="${os.id}" data-action="editar-os"><i class="bi bi-pencil-square"></i></button>
                    <button class="btn btn-sm btn-outline-danger" data-id="${os.id}" data-action="excluir-os"><i class="bi bi-trash3-fill"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }
    
    function renderObjetivos(list) {
        const pendentes = el('#lista-objetivos-pendentes');
        const concluidos = el('#lista-objetivos-concluidos');
        pendentes.innerHTML = '';
        concluidos.innerHTML = '';

        const objetivosPendentes = list.filter(obj => !obj.concluido);
        const objetivosConcluidos = list.filter(obj => obj.concluido);

        if (objetivosPendentes.length === 0) {
            pendentes.innerHTML = '<p class="text-white-50">Nenhum objetivo pendente.</p>';
        } else {
            objetivosPendentes.forEach(obj => {
                const div = document.createElement('div');
                div.className = 'objetivo-item';
                div.innerHTML = `
                    <h6>${obj.tipo === 'os' ? 'Objetivo de O.S.' : 'Objetivo de Produtividade'}</h6>
                    ${obj.tipo === 'os' ? `
                        <p><strong>O.S.:</strong> ${obj.numero_os}</p>
                        <p><strong>Cliente:</strong> ${obj.cliente}</p>
                        <p><strong>Entrega Setor:</strong> ${obj.data_entrega_setor ? formatDate(obj.data_entrega_setor) : 'N/A'}</p>
                        <p><strong>Finalizado:</strong> ${obj.data_final_embalar ? formatDate(obj.data_final_embalar) : 'N/A'}</p>
                    ` : `
                        <p><strong>Setores:</strong> ${obj.setores_envolvidos}</p>
                        <p><strong>Meta de Pedidos:</strong> ${obj.meta_pedidos}</p>
                        <p><strong>Tempo/Setor:</strong> ${obj.tempo_entrega_setor}h</p>
                        <p><strong>Tempo Final:</strong> ${obj.tempo_final_embalar}h</p>
                    `}
                    <button class="btn btn-outline-success btn-sm mt-2" data-id="${obj.id}" data-action="concluir-objetivo">
                        <i class="bi bi-check-circle"></i> Marcar como Concluído
                    </button>
                `;
                pendentes.appendChild(div);
            });
        }
        
        if (objetivosConcluidos.length === 0) {
            concluidos.innerHTML = '<p class="text-white-50">Nenhum objetivo concluído.</p>';
        } else {
            objetivosConcluidos.forEach(obj => {
                const div = document.createElement('div');
                div.className = 'objetivo-item concluido';
                div.innerHTML = `
                    <h6>${obj.tipo === 'os' ? 'Objetivo de O.S.' : 'Objetivo de Produtividade'}</h6>
                    ${obj.tipo === 'os' ? `
                        <p><strong>O.S.:</strong> ${obj.numero_os}</p>
                        <p><strong>Cliente:</strong> ${obj.cliente}</p>
                    ` : `
                        <p><strong>Setores:</strong> ${obj.setores_envolvidos}</p>
                        <p><strong>Meta de Pedidos:</strong> ${obj.meta_pedidos}</p>
                    `}
                    <p class="mt-2 text-success"><i class="bi bi-check-circle-fill"></i> Concluído em ${formatDate(obj.data_conclusao)}</p>
                    <button class="btn btn-outline-secondary btn-sm" data-id="${obj.id}" data-action="reabrir-objetivo">
                        <i class="bi bi-arrow-counterclockwise"></i> Reabrir
                    </button>
                `;
                concluidos.appendChild(div);
            });
        }
    }

    function render() {
        console.log("Renderizando UI...");
        const qTarefas = el('#buscar-tarefas').value.trim().toLowerCase();
        const qOS = el('#buscar-os').value.trim().toLowerCase();

        const pendentesTarefas = tarefas.filter(t => !t.concluida && (!qTarefas || t.titulo.toLowerCase().includes(qTarefas)));
        const concluidas = tarefas.filter(t => t.concluida);
        const osFiltradas = osList.filter(os => !qOS || os.numero_os.toLowerCase().includes(qOS));

        renderTasksTable('#lista-tarefas', pendentesTarefas);
        renderTasksTable('#lista-tarefas-concluidas', concluidas);
        renderOSTable('#lista-os', osFiltradas);
        renderObjetivos(objetivos);
        console.log("Renderização concluída.");
    }

    function setupListeners() {
        console.log("Configurando listeners de dados...");
        onSnapshot(query(collection(db, `artifacts/${appId}/users/${userId}/tarefas`)), (snapshot) => {
            const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            tarefas = docs.sort((a, b) => (b.quando?.toMillis() || 0) - (a.quando?.toMillis() || 0));
            console.log("Tarefas atualizadas:", tarefas.length, "documentos");
            render();
        });

        onSnapshot(query(collection(db, `artifacts/${appId}/users/${userId}/os`)), (snapshot) => {
            const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            osList = docs;
            console.log("O.S. atualizadas:", osList.length, "documentos");
            render();
        });
        
        onSnapshot(query(collection(db, `artifacts/${appId}/public/data/objetivos`)), (snapshot) => {
            const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            objetivos = docs.sort((a, b) => b.data_criacao.toMillis() - a.data_criacao.toMillis());
            console.log("Objetivos atualizados:", objetivos.length, "documentos");
            render();
        });

        document.addEventListener('click', async (ev) => {
            const btn = ev.target.closest('button[data-action]');
            if (!btn) return;
            const id = btn.getAttribute('data-id');
            const action = btn.getAttribute('data-action');
            console.log(`Botão de ação clicado: ${action}, ID: ${id}`);
            
            if (action === 'toggle-concluida') {
                const t = tarefas.find(x => x.id === id);
                if (t) {
                    try {
                        await updateTask(id, { concluida: !t.concluida });
                        console.log("Tarefa atualizada com sucesso.");
                    } catch (error) {
                        console.error("Erro ao atualizar tarefa:", error);
                    }
                }
            } else if (action === 'concluir-objetivo') {
                try {
                    await updateObjetivo(id, { concluido: true, data_conclusao: serverTimestamp() });
                    showNotification('Objetivo concluído! Bom trabalho!');
                    console.log("Objetivo concluído com sucesso.");
                } catch (error) {
                    console.error("Erro ao concluir objetivo:", error);
                }
            } else if (action === 'reabrir-objetivo') {
                try {
                    await updateObjetivo(id, { concluido: false, data_conclusao: null });
                    showNotification('Objetivo reaberto!');
                    console.log("Objetivo reaberto com sucesso.");
                } catch (error) {
                    console.error("Erro ao reabrir objetivo:", error);
                }
            } else if (action === 'editar-task') {
                console.log("Entrando no modo de edição de tarefa.");
                const t = tarefas.find(x => x.id === id);
                if (!t) return;
                el('#tarefas-tab').click(); 
                el('#titulo').value = t.titulo;
                el('#quando').value = t.quando?.toDate().toISOString().slice(0, 16);
                el('#antecedencia').value = t.antecedencia || 0;
                el('#prioridade').value = t.prioridade || 'media';
                el('#notificar').checked = !!t.notificar;

                const form = el('#task-form');
                const originalSubmitHandler = form.onsubmit; 
                
                form.onsubmit = async (ev) => {
                    ev.preventDefault();
                    console.log("Tentando salvar tarefa editada.");
                    const updatedPayload = {
                        titulo: el('#titulo').value.trim(),
                        quando: el('#quando').value ? new Date(el('#quando').value) : null,
                        antecedencia: Number(el('#antecedencia').value),
                        prioridade: el('#prioridade').value,
                        concluida: t.concluida
                    };
                    try {
                        await updateTask(id, updatedPayload);
                        el('#status-area-task').textContent = 'Atualizado.';
                        console.log("Tarefa editada salva com sucesso.");
                    } catch (error) {
                        el('#status-area-task').textContent = 'Erro ao atualizar.';
                        console.error("Erro ao salvar tarefa editada:", error);
                    }
                    form.onsubmit = originalSubmitHandler; 
                    form.reset();
                };
            } else if (action === 'excluir-task') {
                try {
                    await deleteTask(id);
                    console.log("Tarefa excluída com sucesso.");
                } catch (error) {
                    console.error("Erro ao excluir tarefa:", error);
                }
            } else if (action === 'editar-os') {
                console.log("Entrando no modo de edição de O.S.");
                const os = osList.find(x => x.id === id);
                if (!os) return;
                el('#ordem-servico-tab').click(); 
                el('#numero_os').value = os.numero_os;
                el('#cliente').value = os.cliente;
                el('#tecnico').value = os.tecnico;
                el('#descricao_os').value = os.descricao;
                
                const form = el('#os-form');
                const originalSubmitHandler = form.onsubmit;
                
                form.onsubmit = async (ev) => {
                    ev.preventDefault();
                    console.log("Tentando salvar O.S. editada.");
                    const updatedPayload = {
                        numero_os: el('#numero_os').value.trim(),
                        cliente: el('#cliente').value.trim(),
                        tecnico: el('#tecnico').value.trim(),
                        descricao: el('#descricao_os').value.trim(),
                        status: os.status 
                    };
                    try {
                        await updateOS(id, updatedPayload);
                        el('#status-area-os').textContent = 'O.S. atualizada.';
                        console.log("O.S. editada salva com sucesso.");
                    } catch (error) {
                        el('#status-area-os').textContent = 'Erro ao atualizar O.S.';
                        console.error("Erro ao salvar O.S. editada:", error);
                    }
                    form.onsubmit = originalSubmitHandler;
                    form.reset();
                };
            } else if (action === 'excluir-os') {
                try {
                    await deleteOS(id);
                    console.log("O.S. excluída com sucesso.");
                } catch (error) {
                    console.error("Erro ao excluir O.S.:", error);
                }
            }
        });

        el('#buscar-tarefas').addEventListener('input', render);
        el('#buscar-os').addEventListener('input', render);
        
        el('#task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("Formulário de tarefa submetido.");
            const payload = {
                titulo: el('#titulo').value.trim(),
                quando: el('#quando').value ? new Date(el('#quando').value) : null,
                antecedencia: Number(el('#antecedencia').value),
                prioridade: el('#prioridade').value,
                notificar: el('#notificar').checked
            };
            el('#status-area-task').textContent = 'Salvando...';
            try {
                await createTask(payload);
                el('#status-area-task').textContent = 'Tarefa salva.';
                console.log("Nova tarefa criada com sucesso.");
            } catch (error) {
                el('#status-area-task').textContent = 'Erro ao salvar.';
                console.error("Erro ao criar nova tarefa:", error);
            }
            e.target.reset();
        });
        
        el('#os-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("Formulário de O.S. submetido.");
            const payload = {
                numero_os: el('#numero_os').value.trim(),
                cliente: el('#cliente').value.trim(),
                tecnico: el('#tecnico').value.trim(),
                descricao: el('#descricao_os').value.trim()
            };
            el('#status-area-os').textContent = 'Salvando O.S...';
            try {
                await createOS(payload);
                el('#status-area-os').textContent = 'O.S. salva.';
                console.log("Nova O.S. criada com sucesso.");
            } catch (error) {
                el('#status-area-os').textContent = 'Erro ao salvar O.S.';
                console.error("Erro ao criar nova O.S.:", error);
            }
            e.target.reset();
        });
        
        el('#form-objetivo-os').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("Formulário de objetivo de O.S. submetido.");
            const payload = {
                tipo: 'os',
                numero_os: el('#numero_os_obj').value.trim(),
                cliente: el('#cliente_obj').value.trim(),
                data_entrega_setor: el('#data_entrega_setor_obj').value ? new Date(el('#data_entrega_setor_obj').value) : null,
                data_final_embalar: el('#data_final_embalar_obj').value ? new Date(el('#data_final_embalar_obj').value) : null
            };
            el('#status-objetivo-os').textContent = 'Salvando...';
            try {
                await createObjetivo(payload);
                el('#status-objetivo-os').textContent = 'Objetivo de O.S. salvo e visível para todos!';
                showNotification('Novo Objetivo de O.S. Criado!');
                console.log("Novo objetivo de O.S. criado com sucesso.");
            } catch (error) {
                el('#status-objetivo-os').textContent = 'Erro ao salvar.';
                console.error("Erro ao criar novo objetivo de O.S.:", error);
            }
            e.target.reset();
            el('#objetivo-selector').classList.remove('d-none');
            el('#form-objetivo-os').classList.add('d-none');
        });
        
        el('#form-objetivo-produtividade').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("Formulário de objetivo de produtividade submetido.");
            const payload = {
                tipo: 'produtividade',
                setores_envolvidos: el('#setores_envolvidos_obj').value.trim(),
                meta_pedidos: Number(el('#meta_pedidos_obj').value),
                tempo_entrega_setor: Number(el('#tempo_entrega_setor_obj').value),
                tempo_final_embalar: Number(el('#tempo_final_embalar_obj').value)
            };
            el('#status-objetivo-prod').textContent = 'Salvando...';
            try {
                await createObjetivo(payload);
                el('#status-objetivo-prod').textContent = 'Objetivo de Produtividade salvo e visível para todos!';
                showNotification('Novo Objetivo de Produtividade Criado!');
                console.log("Novo objetivo de produtividade criado com sucesso.");
            } catch (error) {
                el('#status-objetivo-prod').textContent = 'Erro ao salvar.';
                console.error("Erro ao criar novo objetivo de produtividade:", error);
            }
            e.target.reset();
            el('#objetivo-selector').classList.remove('d-none');
            el('#form-objetivo-produtividade').classList.add('d-none');
        });
    }

    async function createTask(payload) {
        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/tarefas`), { ...payload, data_criacao: serverTimestamp(), concluida: false });
    }

    async function updateTask(id, payload) {
        await setDoc(doc(db, `artifacts/${appId}/users/${userId}/tarefas`, id), payload, { merge: true });
    }

    async function deleteTask(id) {
        await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/tarefas`, id));
    }

    async function createOS(payload) {
        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/os`), { ...payload, status: 'Liberada' });
    }

    async function updateOS(id, payload) {
        await setDoc(doc(db, `artifacts/${appId}/users/${userId}/os`, id), payload, { merge: true });
    }

    async function deleteOS(id) {
        await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/os`, id));
    }
    
    async function createObjetivo(payload) {
        await addDoc(collection(db, `artifacts/${appId}/public/data/objetivos`), { ...payload, data_criacao: serverTimestamp(), concluido: false });
    }
    
    async function updateObjetivo(id, payload) {
        await setDoc(doc(db, `artifacts/${appId}/public/data/objetivos`, id), payload, { merge: true });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOM carregado. Iniciando aplicativo.");
      
      el('#switch-account-btn').addEventListener('click', function() {
          console.log("Botão 'Trocar de Conta' clicado. Redirecionando...");
          sessionStorage.clear();
          window.location.href = 'login.html';
      });

      el('#btn-objetivo-os').addEventListener('click', () => {
          console.log("Botão 'Objetivo de O.S.' clicado.");
          el('#objetivo-selector').classList.add('d-none');
          el('#form-objetivo-os').classList.remove('d-none');
      });

      el('#btn-objetivo-produtividade').addEventListener('click', () => {
          console.log("Botão 'Objetivo de Produtividade' clicado.");
          el('#objetivo-selector').classList.add('d-none');
          el('#form-objetivo-produtividade').classList.remove('d-none');
      });

      el('#back-to-selector').addEventListener('click', () => {
          console.log("Botão 'Voltar' clicado (form O.S.).");
          el('#objetivo-selector').classList.remove('d-none');
          el('#form-objetivo-os').classList.add('d-none');
          el('#form-objetivo-os').reset();
      });
      
      el('#back-to-selector2').addEventListener('click', () => {
          console.log("Botão 'Voltar' clicado (form Produtividade).");
          el('#objetivo-selector').classList.remove('d-none');
          el('#form-objetivo-produtividade').classList.add('d-none');
          el('#form-objetivo-produtividade').reset();
      });

      (async () => {
          try {
              console.log("Iniciando autenticação Firebase...");
              const app = initializeApp(firebaseConfig);
              db = getFirestore(app);
              auth = getAuth(app);
              if (initialAuthToken) {
                  const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                  userId = userCredential.user.uid;
                  console.log("Autenticado com token customizado. User ID:", userId);
              } else {
                  const userCredential = await signInAnonymously(auth);
                  userId = userCredential.user.uid;
                  console.log("Autenticado anonimamente. User ID:", userId);
              }
              setupListeners();
          } catch (error) {
              console.error("Erro fatal na inicialização do Firebase:", error);
          }
      })();
    });
  </script>
</body>
</html>
