<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grupo ST Comunicaçao Integrada</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <script>
    // Verifica a função do usuário ao carregar a página
    const userRole = sessionStorage.getItem('userRole');
    if (userRole !== 'admin') {
        window.location.href = 'login.html';
    }
  </script>

  <style>
    :root {
      --cor-fundo: #2c3e50; /* Azul acinzentado */
      --cor-card: #34495e;
      --cor-borda: #46607a;
      --cor-texto: #ecf0f1;
      --cor-destaque: #3498db;
      --cor-sucesso: #2ecc71;
      --cor-aviso: #f1c40f;
      --cor-perigo: #e74c3c;
    }
    body {
      background-color: var(--cor-fundo);
      color: var(--cor-texto);
    }
    .card {
      background-color: var(--cor-card);
      border: 1px solid var(--cor-borda);
    }
    .card-title, .form-label, .table-dark thead th {
      color: var(--cor-texto) !important;
    }
    .form-control, .form-select {
      background-color: var(--cor-card);
      border: 1px solid var(--cor-borda);
      color: var(--cor-texto);
    }
    .form-control::placeholder {
      color: #bdc3c7;
    }
    .table-dark thead th {
      background-color: var(--cor-card);
      border-color: var(--cor-borda);
    }
    .table-dark tbody tr {
      border-color: var(--cor-borda);
    }
    .nav-tabs .nav-link {
      color: var(--cor-texto);
      border: 1px solid transparent;
      border-bottom: 1px solid var(--cor-borda);
      background-color: var(--cor-fundo);
    }
    .nav-tabs .nav-link.active {
      background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
      color: var(--cor-destaque);
      border-color: var(--cor-borda);
      border-bottom-color: transparent;
    }
    .btn-primary {
      background-color: var(--cor-destaque);
      border-color: var(--cor-destaque);
    }
    .btn-primary:hover {
      background-color: #2980b9;
      border-color: #2980b9;
    }
    .concluida {
      text-decoration: line-through;
      color: #95a5a6 !important;
    }
    .badge-prioridade-baixa { background-color: var(--cor-sucesso); }
    .badge-prioridade-media { background-color: var(--cor-aviso); color: #000; }
    .badge-prioridade-alta { background-color: var(--cor-perigo); }
    .navbar {
      background-color: var(--cor-card);
      border-bottom: 1px solid var(--cor-borda);
    }
    .navbar-brand {
      color: var(--cor-texto) !important;
    }
    .btn-outline-secondary {
      color: var(--cor-texto);
      border-color: var(--cor-borda);
    }
    .btn-outline-danger {
      color: var(--cor-perigo);
      border-color: var(--cor-perigo);
    }
    .btn-outline-success {
      color: var(--cor-sucesso);
      border-color: var(--cor-sucesso);
    }
    #userIdDisplay {
        font-size: 0.8rem;
        color: #7f8c8d;
        word-break: break-all;
    }
  </style>
</head>
<body>
  
  <div class="container mt-4">
    <div class="card p-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <img src="/images/image_64f7fe.png" alt="Logo da Empresa" style="max-height: 80px;">
        <div class="text-end">
            <p id="userIdDisplay" class="mb-1"></p>
            <button id="logout-btn" class="btn btn-outline-danger">
                <i class="bi bi-box-arrow-right"></i> Sair
            </button>
        </div>
      </div>
      <h1 class="card-title text-center p-3">Grupo ST Comunicaçao Integrada</h1>

      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="index.html" aria-selected="true">Objetivos</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="almoxarifado.html" aria-selected="false">Almoxarifado</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="pcp.html" aria-selected="false">PCP</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="producao.html" aria-selected="false">Produção</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="expedicao.html" aria-selected="false">Expedição</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="index.html#tarefas" aria-selected="false">Tarefas</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="index.html#ordem-servico" aria-selected="false">O.S</a>
        </li>
      </ul>

      <div class="tab-content mt-3" id="myTabContent">
        <div class="tab-pane fade show active" id="objetivos" role="tabpanel" aria-labelledby="objetivos-tab">
            <h5 class="text-white">Conteúdo do Módulo de Objetivos</h5>
            <p>Aqui você poderá adicionar e acompanhar seus objetivos.</p>
        </div>
        <div class="tab-pane fade" id="almoxarifado" role="tabpanel" aria-labelledby="almoxarifado-tab">
            <h5 class="text-white">Conteúdo do Módulo de Almoxarifado</h5>
            <p>Este módulo agora está em um arquivo separado para melhor organização.</p>
        </div>
        <div class="tab-pane fade" id="pcp" role="tabpanel" aria-labelledby="pcp-tab">
            <h5 class="text-white">Conteúdo do Módulo de PCP</h5>
            <p>Este módulo agora está em um arquivo separado para melhor organização.</p>
        </div>
        <div class="tab-pane fade" id="producao" role="tabpanel" aria-labelledby="producao-tab">
            <h5 class="text-white">Conteúdo do Módulo de Produção</h5>
            <p>Este módulo agora está em um arquivo separado para melhor organização.</p>
        </div>
        <div class="tab-pane fade" id="expedicao" role="tabpanel" aria-labelledby="expedicao-tab">
            <h5 class="text-white">Conteúdo do Módulo de Expedição</h5>
            <p>Acompanhamento dos pedidos para envio.</p>
        </div>
        <div class="tab-pane fade" id="tarefas" role="tabpanel" aria-labelledby="tarefas-tab">
          <form id="task-form" class="mb-3">
            <div class="mb-3">
              <label for="titulo" class="form-label">Título da Tarefa</label>
              <input type="text" class="form-control" id="titulo" required>
            </div>
            <div class="mb-3">
              <label for="quando" class="form-label">Quando</label>
              <input type="datetime-local" class="form-control" id="quando">
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="antecedencia" class="form-label">Notificar com (minutos)</label>
                <input type="number" class="form-control" id="antecedencia" value="0">
              </div>
              <div class="col-md-6 mb-3">
                <label for="prioridade" class="form-label">Prioridade</label>
                <select class="form-select" id="prioridade">
                  <option value="baixa">Baixa</option>
                  <option value="media" selected>Média</option>
                  <option value="alta">Alta</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label for="descricao" class="form-label">Descrição (opcional)</label>
              <textarea class="form-control" id="descricao" rows="3"></textarea>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="notificar">
              <label class="form-check-label" for="notificar">Habilitar Notificação</label>
            </div>
            <button type="submit" class="btn btn-primary w-100">Salvar Tarefa</button>
            <p id="status-area-task" class="mt-2 text-center text-white"></p>
          </form>
          <div class="input-group mb-3">
            <span class="input-group-text bg-dark border-secondary text-white"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="buscar-tarefas" placeholder="Buscar tarefas...">
          </div>
          <h5 class="text-white">Tarefas Pendentes</h5>
          <div class="table-responsive">
            <table class="table table-dark table-hover table-sm">
              <thead>
                <tr>
                  <th>Título</th>
                  <th>Quando</th>
                  <th>Prioridade</th>
                  <th>Ações</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="lista-tarefas">
              </tbody>
            </table>
          </div>
          <h5 class="text-white mt-4">Tarefas Concluídas</h5>
          <div class="table-responsive">
            <table class="table table-dark table-hover table-sm">
              <thead>
                <tr>
                  <th>Título</th>
                  <th>Quando</th>
                  <th>Prioridade</th>
                  <th>Ações</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="lista-tarefas-concluidas">
              </tbody>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="ordem-servico" role="tabpanel" aria-labelledby="ordem-servico-tab">
            <div class="input-group mb-3">
                <span class="input-group-text bg-dark border-secondary text-white"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" id="buscar-os" placeholder="Buscar O.S. por número...">
            </div>
            <form id="os-form" class="mb-3">
                <div class="mb-3">
                    <label for="numero_os" class="form-label">Número da O.S.</label>
                    <input type="text" class="form-control" id="numero_os" required>
                </div>
                <div class="mb-3">
                    <label for="cliente" class="form-label">Cliente</label>
                    <input type="text" class="form-control" id="cliente" required>
                </div>
                <div class="mb-3">
                    <label for="tecnico" class="form-label">Técnico</label>
                    <input type="text" class="form-control" id="tecnico">
                </div>
                <div class="mb-3">
                    <label for="descricao_os" class="form-label">Descrição</label>
                    <textarea class="form-control" id="descricao_os" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100">Salvar O.S.</button>
                <p id="status-area-os" class="mt-2 text-center text-white"></p>
            </form>
            <div class="table-responsive">
              <table class="table table-dark table-hover table-sm">
                <thead>
                  <tr>
                    <th>O.S.</th>
                    <th>Cliente</th>
                    <th>Técnico</th>
                    <th>Status</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="lista-os">
                </tbody>
              </table>
            </div>
        </div>
      </div>
      
      <div class="mt-4 text-center">
        <button id="exportar" class="btn btn-outline-success">Exportar Dados</button>
        <button id="apagarTudo" class="btn btn-outline-danger">Apagar Tudo</button>
      </div>

    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Configurações e variáveis globais do ambiente
    setLogLevel('debug');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Inicialização do Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let userId = null;

    // Elementos do DOM
    function el(sel) { return document.querySelector(sel); }
    const userIdDisplay = el('#userIdDisplay');

    // Estado da aplicação
    let tarefas = [];
    let osList = [];
    
    // Funções auxiliares
    function formatDate(timestamp) {
      if (!timestamp) return '';
      const d = timestamp.toDate();
      return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    // Funções de renderização
    function renderTasksTable(tbodySel, list) {
        const tbody = el(tbodySel);
        tbody.innerHTML = '';
        if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-white text-center">Sem tarefas.</td></tr>';
            return;
        }
        list.forEach(t => {
            const tr = document.createElement('tr');
            
            let prioridadeBadgeClass = 'badge bg-secondary';
            if (t.prioridade === 'baixa') {
                prioridadeBadgeClass = 'badge badge-prioridade-baixa';
            } else if (t.prioridade === 'media') {
                prioridadeBadgeClass = 'badge badge-prioridade-media';
            } else if (t.prioridade === 'alta') {
                prioridadeBadgeClass = 'badge badge-prioridade-alta';
            }
            const concluidaClass = t.concluida ? 'concluida' : '';

            tr.innerHTML = `
                <td class="${concluidaClass}">${t.titulo}</td>
                <td class="${concluidaClass}">${t.quando ? formatDate(t.quando) : 'N/A'}</td>
                <td><span class="${prioridadeBadgeClass}">${t.prioridade}</span></td>
                <td>
                    <button class="btn btn-sm btn-link text-white text-decoration-none" data-id="${t.id}" data-action="toggle-concluida">
                        ${t.concluida ? 'Reabrir' : 'Concluir'}
                    </button>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary" data-id="${t.id}" data-action="editar-task"><i class="bi bi-pencil-square"></i></button>
                    <button class="btn btn-sm btn-outline-danger" data-id="${t.id}" data-action="excluir-task"><i class="bi bi-trash3-fill"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderOSTable(tbodySel, list) {
        const tbody = el(tbodySel);
        tbody.innerHTML = '';
        if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-white text-center">Sem O.S. Liberadas.</td></tr>';
            return;
        }
        list.forEach(os => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${os.numero_os}</td>
                <td>${os.cliente}</td>
                <td>${os.tecnico || 'N/A'}</td>
                <td>${os.status}</td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary" data-id="${os.id}" data-action="editar-os"><i class="bi bi-pencil-square"></i></button>
                    <button class="btn btn-sm btn-outline-danger" data-id="${os.id}" data-action="excluir-os"><i class="bi bi-trash3-fill"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Renderização principal e filtros
    function render() {
        const qTarefas = el('#buscar-tarefas').value.trim().toLowerCase();
        const qOS = el('#buscar-os').value.trim().toLowerCase();

        const pendentesTarefas = tarefas.filter(t => !t.concluida && (!qTarefas || t.titulo.toLowerCase().includes(qTarefas)));
        const concluidas = tarefas.filter(t => t.concluida);
        const osFiltradas = osList.filter(os => !qOS || os.numero_os.toLowerCase().includes(qOS));

        renderTasksTable('#lista-tarefas', pendentesTarefas);
        renderTasksTable('#lista-tarefas-concluidas', concluidas);
        renderOSTable('#lista-os', osFiltradas);
    }

    // Listeners do Firebase
    function setupListeners() {
        // Tarefas
        onSnapshot(query(collection(db, `artifacts/${appId}/users/${userId}/tarefas`)), (snapshot) => {
            const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            tarefas = docs.sort((a, b) => (b.quando?.toMillis() || 0) - (a.quando?.toMillis() || 0));
            render();
        });

        // Ordens de Serviço (O.S)
        onSnapshot(query(collection(db, `artifacts/${appId}/users/${userId}/os`)), (snapshot) => {
            const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            osList = docs;
            render();
        });
    }

    // Funções de manipulação de dados no Firestore
    async function createTask(payload) {
        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/tarefas`), { ...payload, data_criacao: serverTimestamp(), concluida: false });
    }

    async function updateTask(id, payload) {
        await setDoc(doc(db, `artifacts/${appId}/users/${userId}/tarefas`, id), payload, { merge: true });
    }

    async function deleteTask(id) {
        await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/tarefas`, id));
    }

    async function createOS(payload) {
        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/os`), { ...payload, status: 'Liberada' });
    }

    async function updateOS(id, payload) {
        await setDoc(doc(db, `artifacts/${appId}/users/${userId}/os`, id), payload, { merge: true });
    }

    async function deleteOS(id) {
        await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/os`, id));
    }

    // Eventos e inicialização
    el('#task-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            titulo: el('#titulo').value.trim(),
            quando: el('#quando').value ? new Date(el('#quando').value) : null,
            antecedencia: Number(el('#antecedencia').value),
            prioridade: el('#prioridade').value,
            descricao: el('#descricao').value.trim(),
            notificar: el('#notificar').checked
        };
        el('#status-area-task').textContent = 'Salvando...';
        await createTask(payload);
        el('#status-area-task').textContent = 'Tarefa salva.';
        e.target.reset();
    });

    el('#os-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            numero_os: el('#numero_os').value.trim(),
            cliente: el('#cliente').value.trim(),
            tecnico: el('#tecnico').value.trim(),
            descricao: el('#descricao_os').value.trim()
        };
        el('#status-area-os').textContent = 'Salvando O.S...';
        await createOS(payload);
        el('#status-area-os').textContent = 'O.S. salva.';
        e.target.reset();
    });

    document.addEventListener('click', async (ev) => {
        const btn = ev.target.closest('button[data-action]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        
        if (action === 'toggle-concluida') {
            const t = tarefas.find(x => x.id === id);
            if (t) {
                await updateTask(id, { concluida: !t.concluida });
            }
        } else if (action === 'editar-task') {
            const t = tarefas.find(x => x.id === id);
            if (!t) return;
            el('#tarefas-tab').click(); 
            el('#titulo').value = t.titulo;
            el('#quando').value = t.quando?.toDate().toISOString().slice(0, 16);
            el('#antecedencia').value = t.antecedencia || 0;
            el('#prioridade').value = t.prioridade || 'media';
            el('#descricao').value = t.descricao || '';
            el('#notificar').checked = !!t.notificar;

            const form = el('#task-form');
            const originalSubmitHandler = form.onsubmit; 
            
            form.onsubmit = async (ev) => {
                ev.preventDefault();
                const updatedPayload = {
                    titulo: el('#titulo').value.trim(),
                    quando: el('#quando').value ? new Date(el('#quando').value) : null,
                    antecedencia: Number(el('#antecedencia').value),
                    prioridade: el('#prioridade').value,
                    descricao: el('#descricao').value.trim(),
                    concluida: t.concluida
                };
                await updateTask(id, updatedPayload);
                el('#status-area-task').textContent = 'Atualizado.';
                form.onsubmit = originalSubmitHandler; 
                form.reset();
            };
        } else if (action === 'excluir-task') {
            await deleteTask(id);
        } else if (action === 'editar-os') {
            const os = osList.find(x => x.id === id);
            if (!os) return;
            el('#ordem-servico-tab').click(); 
            el('#numero_os').value = os.numero_os;
            el('#cliente').value = os.cliente;
            el('#tecnico').value = os.tecnico;
            el('#descricao_os').value = os.descricao;
            
            const form = el('#os-form');
            const originalSubmitHandler = form.onsubmit;
            
            form.onsubmit = async (ev) => {
                ev.preventDefault();
                const updatedPayload = {
                    numero_os: el('#numero_os').value.trim(),
                    cliente: el('#cliente').value.trim(),
                    tecnico: el('#tecnico').value.trim(),
                    descricao: el('#descricao_os').value.trim(),
                    status: os.status 
                };
                await updateOS(id, updatedPayload);
                el('#status-area-os').textContent = 'O.S. atualizada.';
                form.onsubmit = originalSubmitHandler;
                form.reset();
            };
        } else if (action === 'excluir-os') {
            await deleteOS(id);
        }
    });

    el('#buscar-tarefas').addEventListener('input', render);
    el('#buscar-os').addEventListener('input', render);
    
    el('#logout-btn').addEventListener('click', function() {
        sessionStorage.clear();
        window.location.href = 'login.html';
    });

    // Início da aplicação
    (async () => {
      try {
        if (initialAuthToken) {
          const userCredential = await signInWithCustomToken(auth, initialAuthToken);
          userId = userCredential.user.uid;
        } else {
          const userCredential = await signInAnonymously(auth);
          userId = userCredential.user.uid;
        }
        
        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            userIdDisplay.textContent = `ID do Usuário: ${userId}`;
            setupListeners();
          } else {
            console.log("Nenhum usuário logado. O sistema não funcionará corretamente.");
          }
        });

      } catch (error) {
        console.error("Erro na autenticação:", error);
      }
    })();
  </script>
</body>
</html>
