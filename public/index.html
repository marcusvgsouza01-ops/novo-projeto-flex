<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grupo ST Comunicaçao Integrada</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    body {
      background-color: #0b0f14;
      color: #e8f0f7;
    }
    .card {
      background-color: #121820;
      border: 1px solid #1e2a36;
    }
    .card-title, .form-label {
      color: #e8f0f7 !important;
    }
    .form-control, .form-select {
      background-color: #0d131a;
      border: 1px solid #1e2a36;
      color: #e8f0f7;
    }
    .form-control::placeholder {
      color: #9fb3c8;
    }
    .table-dark thead th {
      background-color: #0f151c;
      border-color: #1e2a36;
    }
    .table-dark tbody tr {
      border-color: #1e2a36;
    }
    .nav-tabs .nav-link {
      color: #e8f0f7;
      border: 1px solid transparent;
      border-bottom: 1px solid #1e2a36;
      background-color: #0d131a;
    }
    .nav-tabs .nav-link.active {
      color: #fff;
      background-color: #121820;
      border-color: #1e2a36;
      border-bottom-color: #121820;
    }
    .concluida {
      text-decoration: line-through;
      color: #6c757d !important;
    }
    .badge-prioridade-baixa { background-color: #28a745; }
    .badge-prioridade-media { background-color: #ffc107; color: #000; }
    .badge-prioridade-alta { background-color: #dc3545; }
    .navbar {
      background-color: #121820;
      border-bottom: 1px solid #1e2a36;
    }
    .navbar-brand {
      color: #e8f0f7 !important;
    }
  </style>
</head>
<body>
  
  <div class="container mt-4">
    <div class="card p-4">
      <div class="d-flex justify-content-center">
        <img src="https://i.imgur.com/vH9x92x.png" alt="Logo FLEX" style="max-height: 100px;">
      </div>
      <h1 class="card-title text-center p-3">Grupo ST Comunicaçao Integrada</h1>

      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tarefas-tab" data-bs-toggle="tab" data-bs-target="#tarefas" type="button" role="tab" aria-controls="tarefas" aria-selected="true">Tarefas</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="nova-tarefa-tab" data-bs-toggle="tab" data-bs-target="#nova-tarefa" type="button" role="tab" aria-controls="nova-tarefa" aria-selected="false">Nova Tarefa</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ordem-servico-tab" data-bs-toggle="tab" data-bs-target="#ordem-servico" type="button" role="tab" aria-controls="ordem-servico" aria-selected="false">O.S</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="almoxarifado-tab" data-bs-toggle="tab" data-bs-target="#almoxarifado" type="button" role="tab" aria-controls="almoxarifado" aria-selected="false">Almoxarifado</button>
        </li>
      </ul>

      <div class="tab-content mt-3" id="myTabContent">
        <div class="tab-pane fade show active" id="tarefas" role="tabpanel" aria-labelledby="tarefas-tab">
          <div class="input-group mb-3">
            <span class="input-group-text bg-dark border-secondary text-white"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="buscar-tarefas" placeholder="Buscar tarefas...">
          </div>
          <h5 class="text-white">Tarefas Pendentes</h5>
          <div class="table-responsive">
            <table class="table table-dark table-hover table-sm">
              <thead>
                <tr>
                  <th>Título</th>
                  <th>Quando</th>
                  <th>Prioridade</th>
                  <th>Ações</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="lista-tarefas">
              </tbody>
            </table>
          </div>
          <h5 class="text-white mt-4">Tarefas Concluídas</h5>
          <div class="table-responsive">
            <table class="table table-dark table-hover table-sm">
              <thead>
                <tr>
                  <th>Título</th>
                  <th>Quando</th>
                  <th>Prioridade</th>
                  <th>Ações</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="lista-tarefas-concluidas">
              </tbody>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="nova-tarefa" role="tabpanel" aria-labelledby="nova-tarefa-tab">
          <form id="task-form">
            <div class="mb-3">
              <label for="titulo" class="form-label">Título da Tarefa</label>
              <input type="text" class="form-control" id="titulo" required>
            </div>
            <div class="mb-3">
              <label for="quando" class="form-label">Quando</label>
              <input type="datetime-local" class="form-control" id="quando">
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="antecedencia" class="form-label">Notificar com (minutos)</label>
                <input type="number" class="form-control" id="antecedencia" value="0">
              </div>
              <div class="col-md-6 mb-3">
                <label for="prioridade" class="form-label">Prioridade</label>
                <select class="form-select" id="prioridade">
                  <option value="baixa">Baixa</option>
                  <option value="media" selected>Média</option>
                  <option value="alta">Alta</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label for="descricao" class="form-label">Descrição (opcional)</label>
              <textarea class="form-control" id="descricao" rows="3"></textarea>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="notificar">
              <label class="form-check-label" for="notificar">Habilitar Notificação</label>
            </div>
            <button type="submit" class="btn btn-primary w-100">Salvar Tarefa</button>
            <p id="status-area-task" class="mt-2 text-center text-white"></p>
          </form>
        </div>
        <div class="tab-pane fade" id="ordem-servico" role="tabpanel" aria-labelledby="ordem-servico-tab">
            <div class="input-group mb-3">
                <span class="input-group-text bg-dark border-secondary text-white"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" id="buscar-os" placeholder="Buscar O.S. por número...">
            </div>
            <form id="os-form" class="mb-3">
                <div class="mb-3">
                    <label for="numero_os" class="form-label">Número da O.S.</label>
                    <input type="text" class="form-control" id="numero_os" required>
                </div>
                <div class="mb-3">
                    <label for="cliente" class="form-label">Cliente</label>
                    <input type="text" class="form-control" id="cliente" required>
                </div>
                <div class="mb-3">
                    <label for="tecnico" class="form-label">Técnico</label>
                    <input type="text" class="form-control" id="tecnico">
                </div>
                <div class="mb-3">
                    <label for="descricao_os" class="form-label">Descrição</label>
                    <textarea class="form-control" id="descricao_os" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100">Salvar O.S.</button>
                <p id="status-area-os" class="mt-2 text-center text-white"></p>
            </form>
            <div class="table-responsive">
              <table class="table table-dark table-hover table-sm">
                <thead>
                  <tr>
                    <th>O.S.</th>
                    <th>Cliente</th>
                    <th>Técnico</th>
                    <th>Status</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="lista-os">
                </tbody>
              </table>
            </div>
        </div>
        <div class="tab-pane fade" id="almoxarifado" role="tabpanel" aria-labelledby="almoxarifado-tab">
            <form id="form-almoxarifado" class="mb-3">
                <div class="mb-3">
                    <label for="item-almoxarifado" class="form-label">Item</label>
                    <input type="text" class="form-control" id="item-almoxarifado" required>
                </div>
                <div class="mb-3">
                    <label for="quantidade-almoxarifado" class="form-label">Quantidade</label>
                    <input type="number" class="form-control" id="quantidade-almoxarifado" required>
                </div>
                <div class="mb-3">
                    <label for="responsavel-almoxarifado" class="form-label">Responsável</label>
                    <input type="text" class="form-control" id="responsavel-almoxarifado" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Adicionar Item</button>
            </form>
            <div class="table-responsive">
              <table class="table table-dark table-hover table-sm">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Item</th>
                    <th>Quantidade</th>
                    <th>Responsável</th>
                    <th>Data</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="lista-almoxarifado">
                </tbody>
              </table>
            </div>
        </div>
      </div>
      
      <div class="mt-4 text-center">
        <button id="exportar" class="btn btn-outline-success">Exportar Dados</button>
        <button id="apagarTudo" class="btn btn-outline-danger">Apagar Tudo</button>
      </div>

    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const API_URL = 'https://stflex-app-consulta.onrender.com';
  const API_TASKS = `${API_URL}/api/tasks`;
  const API_OS = `${API_URL}/api/os`;
  const API_ALMOXARIFADO = `${API_URL}/api/almoxarifado`;

  let tarefas = [];
  let osList = [];
  let almoxarifadoList = [];

  function el(sel){return document.querySelector(sel)}
  function formatDate(iso){ 
      if(!iso) return ''; 
      const d=new Date(iso); 
      return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); 
  }

  // render tabela de tarefas
  function renderTasksTable(tbodySel, list) {
    const tbody = el(tbodySel);
    tbody.innerHTML = '';
    if (list.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-white text-center">Sem tarefas.</td></tr>';
      return;
    }
    list.forEach(t => {
      const tr = document.createElement('tr');
      
      let prioridadeBadgeClass = 'badge bg-secondary';
      if (t.prioridade === 'baixa') {
          prioridadeBadgeClass = 'badge badge-prioridade-baixa';
      } else if (t.prioridade === 'media') {
          prioridadeBadgeClass = 'badge badge-prioridade-media';
      } else if (t.prioridade === 'alta') {
          prioridadeBadgeClass = 'badge badge-prioridade-alta';
      }
      const concluidaClass = t.concluida ? 'concluida' : '';

      tr.innerHTML = `
        <td class="${concluidaClass}">${t.titulo}</td>
        <td class="${concluidaClass}">${formatDate(t.quando)}</td>
        <td><span class="${prioridadeBadgeClass}">${t.prioridade}</span></td>
        <td>
          <button class="btn btn-sm btn-link text-white text-decoration-none" data-id="${t.id}" data-action="toggle-concluida">
              ${t.concluida ? 'Reabrir' : 'Concluir'}
          </button>
        </td>
        <td>
          <button class="btn btn-sm btn-outline-secondary" data-id="${t.id}" data-action="editar-task"><i class="bi bi-pencil-square"></i></button>
          <button class="btn btn-sm btn-outline-danger" data-id="${t.id}" data-action="excluir-task"><i class="bi bi-trash3-fill"></i></button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // render tabela de O.S.
  function renderOSTable(tbodySel, list) {
    const tbody = el(tbodySel);
    tbody.innerHTML = '';
    if (list.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-white text-center">Sem O.S. Liberadas.</td></tr>';
      return;
    }
    list.forEach(os => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${os.numero_os}</td>
        <td>${os.cliente}</td>
        <td>${os.tecnico || 'N/A'}</td>
        <td>${os.status}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary" data-id="${os.id}" data-action="editar-os"><i class="bi bi-pencil-square"></i></button>
          <button class="btn btn-sm btn-outline-danger" data-id="${os.id}" data-action="excluir-os"><i class="bi bi-trash3-fill"></i></button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // render tabela de Almoxarifado
  function renderAlmoxarifadoTable(tbodySel, list) {
    const tbody = el(tbodySel);
    tbody.innerHTML = '';
    if (list.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-white text-center">Nenhum item cadastrado.</td></tr>';
      return;
    }
    list.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.id}</td>
        <td>${item.item}</td>
        <td>${item.quantidade}</td>
        <td>${item.responsavel}</td>
        <td>${formatDate(item.data_registro)}</td>
        <td>
          <button class="btn btn-sm btn-outline-danger" data-id="${item.id}" data-action="excluir-almoxarifado"><i class="bi bi-trash3-fill"></i></button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // render listas
  function render() {
    const qTarefas = el('#buscar-tarefas').value.trim().toLowerCase();
    const qOS = el('#buscar-os').value.trim().toLowerCase();

    const pendentesTarefas = tarefas.filter(t => !t.concluida && (!qTarefas || t.titulo.toLowerCase().includes(qTarefas)))
      .sort((a, b) => new Date(a.quando) - new Date(b.quando));
    
    const concluidas = tarefas.filter(t => t.concluida)
      .sort((a, b) => new Date(a.quando) - new Date(b.quando));

    const osFiltradas = osList.filter(os => !qOS || os.numero_os.toLowerCase().includes(qOS));

    renderTasksTable('#lista-tarefas', pendentesTarefas);
    renderTasksTable('#lista-tarefas-concluidas', concluidas);
    renderOSTable('#lista-os', osFiltradas);
    renderAlmoxarifadoTable('#lista-almoxarifado', almoxarifadoList);
  }

  // API calls
  async function loadAllData(){
    try{
      const [resTasks, resOS, resAlmoxarifado] = await Promise.all([
        fetch(API_TASKS),
        fetch(API_OS),
        fetch(API_ALMOXARIFADO)
      ]);
      
      tarefas = await resTasks.json();
      osList = await resOS.json();
      almoxarifadoList = await resAlmoxarifado.json();
      
      render();
      scheduleAllNotifications();
    }catch(err){
      console.error(err);
    }
  }

  async function createTask(payload){
    const res = await fetch(API_TASKS, {
      method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function updateTask(id, payload){
    const res = await fetch(`${API_TASKS}/${id}`, {
      method:'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function deleteTask(id){
    await fetch(`${API_TASKS}/${id}`, { method:'DELETE' });
  }

  async function createOS(payload){
    const res = await fetch(API_OS, {
      method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function updateOS(id, payload){
    const res = await fetch(`${API_OS}/${id}`, {
      method:'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function deleteOS(id){
    await fetch(`${API_OS}/${id}`, { method:'DELETE' });
  }

  async function createAlmoxarifadoItem(payload){
    const res = await fetch(API_ALMOXARIFADO, {
      method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function deleteAlmoxarifadoItem(id){
    await fetch(`${API_ALMOXARIFADO}/${id}`, { method:'DELETE' });
  }

  // notifications
  async function requestPermission(){
    if('Notification' in window && Notification.permission !== 'granted'){
      await Notification.requestPermission();
    }
  }

  function scheduleNotification(t){
    if(!t.notificar) return;
    try{
      const when = new Date(t.quando).getTime() - (t.antecedencia||0)*60000;
      const delay = when - Date.now();
      if(delay > 0){
        setTimeout(()=>{
          if(Notification.permission === 'granted'){
            new Notification('Lembrete: ' + t.titulo, { body: t.descricao || formatDate(t.quando) });
          } else {
            console.log('Notificação não permitida.');
          }
        }, delay);
      }
    }catch(e){ console.error('Erro ao agendar notificação', e); }
  }

  function scheduleAllNotifications(){
    tarefas.forEach(scheduleNotification);
  }

  // form submits
  el('#task-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      titulo: el('#titulo').value.trim(),
      quando: el('#quando').value,
      antecedencia: Number(el('#antecedencia').value),
      prioridade: el('#prioridade').value,
      descricao: el('#descricao').value.trim(),
      notificar: el('#notificar').checked ? 1 : 0
    };
    el('#status-area-task').textContent = 'Salvando...';
    try{
      const created = await createTask(payload);
      tarefas.push(created);
      render();
      scheduleNotification(created);
      el('#status-area-task').textContent = 'Tarefa salva.';
      e.target.reset();
    }catch(err){
      console.error(err);
      el('#status-area-task').textContent = 'Erro ao salvar.';
    }
  });

  el('#os-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      numero_os: el('#numero_os').value.trim(),
      cliente: el('#cliente').value.trim(),
      tecnico: el('#tecnico').value.trim(),
      descricao: el('#descricao_os').value.trim()
    };
    el('#status-area-os').textContent = 'Salvando O.S...';
    try{
      const created = await createOS(payload);
      osList.push(created);
      render();
      el('#status-area-os').textContent = 'O.S. salva.';
      e.target.reset();
    }catch(err){
      console.error(err);
      el('#status-area-os').textContent = 'Erro ao salvar O.S.';
    }
  });

  el('#form-almoxarifado').addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = {
        item: el('#item-almoxarifado').value.trim(),
        quantidade: Number(el('#quantidade-almoxarifado').value),
        responsavel: el('#responsavel-almoxarifado').value.trim()
    };
    try {
        const created = await createAlmoxarifadoItem(payload);
        almoxarifadoList.push(created);
        render();
        e.target.reset();
    } catch (err) {
        console.error('Erro ao salvar item do almoxarifado:', err);
    }
  });

  // delegação de eventos para ações
  document.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button[data-action]');
    if(!btn) return;
    const id = btn.getAttribute('data-id');
    const action = btn.getAttribute('data-action');
    
    if(action === 'toggle-concluida'){
      const t = tarefas.find(x=>String(x.id) === String(id));
      if (t) {
          const payload = { ...t, concluida: t.concluida ? 0 : 1 }; 
          const updated = await updateTask(id, payload);
          tarefas = tarefas.map(x => x.id === updated.id ? updated : x);
          render();
      }
    } else if(action === 'editar-task'){
      const t = tarefas.find(x=>String(x.id) === String(id));
      if(!t) return;
      el('#nova-tarefa-tab').click();
      el('#titulo').value = t.titulo;
      const dt = new Date(t.quando);
      const pad = n=>String(n).padStart(2,'0');
      const yyyy = dt.getFullYear();
      const mm = pad(dt.getMonth()+1);
      const dd = pad(dt.getDate());
      const hh = pad(dt.getHours());
      const min = pad(dt.getMinutes());
      el('#quando').value = `${yyyy}-${mm}-${dd}T${hh}:${min}`;
      el('#antecedencia').value = t.antecedencia || 0;
      el('#prioridade').value = t.prioridade || 'media';
      el('#descricao').value = t.descricao || '';
      el('#notificar').checked = !!t.notificar;

      const form = el('#task-form');
      const originalSubmitHandler = form.onsubmit; 
      
      form.onsubmit = async (ev)=>{
        ev.preventDefault();
        const updatedPayload = {
          titulo: el('#titulo').value.trim(),
          quando: el('#quando').value,
          antecedencia: Number(el('#antecedencia').value),
          prioridade: el('#prioridade').value,
          descricao: el('#descricao').value.trim(),
          notificar: el('#notificar').checked ? 1 : 0,
          concluida: t.concluida ? 1 : 0
        };
        const updated = await updateTask(id, updatedPayload);
        tarefas = tarefas.map(x=> x.id===updated.id?updated:x);
        render();
        scheduleAllNotifications();
        el('#status-area-task').textContent = 'Atualizado.';
        form.onsubmit = originalSubmitHandler; 
        form.reset();
      };
    } else if(action === 'excluir-task'){
      if(!confirm('Excluir essa tarefa?')) return;
      await deleteTask(id);
      tarefas = tarefas.filter(x=> String(x.id) !== String(id));
      render();
    } else if(action === 'editar-os'){
      const os = osList.find(x => String(x.id) === String(id));
      if (!os) return;
      el('#nova-os-tab').click();
      el('#numero_os').value = os.numero_os;
      el('#cliente').value = os.cliente;
      el('#tecnico').value = os.tecnico;
      el('#descricao_os').value = os.descricao;
      
      const form = el('#os-form');
      const originalSubmitHandler = form.onsubmit;
      
      form.onsubmit = async (ev) => {
        ev.preventDefault();
        const updatedPayload = {
          numero_os: el('#numero_os').value.trim(),
          cliente: el('#cliente').value.trim(),
          tecnico: el('#tecnico').value.trim(),
          descricao: el('#descricao_os').value.trim(),
          status: os.status 
        };
        const updated = await updateOS(id, updatedPayload);
        osList = osList.map(x => x.id === updated.id ? updated : x);
        render();
        el('#status-area-os').textContent = 'O.S. atualizada.';
        form.onsubmit = originalSubmitHandler;
        form.reset();
      };
    } else if(action === 'excluir-os'){
      if(!confirm('Excluir essa O.S.?')) return;
      await deleteOS(id);
      osList = osList.filter(x=> String(x.id) !== String(id));
      render();
    } else if (action === 'excluir-almoxarifado') {
      if (!confirm('Excluir este item do almoxarifado?')) return;
      await deleteAlmoxarifadoItem(id);
      almoxarifadoList = almoxarifadoList.filter(x => String(x.id) !== String(id));
      render();
    }
  });

  // exportar / limpar
  el('#exportar').addEventListener('click', ()=>{
    const data = { tarefas, os: osList, almoxarifado: almoxarifadoList };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'dados_agenda.json';
    a.click();
  });

  el('#apagarTudo').addEventListener('click', async ()=>{
    if(!confirm('Apagar todos os dados do servidor? Esta ação é irreversível.')) return;
    for(const t of tarefas){ await deleteTask(t.id); }
    for(const os of osList){ await deleteOS(os.id); }
    for(const item of almoxarifadoList){ await deleteAlmoxarifadoItem(item.id); }
    tarefas = [];
    osList = [];
    almoxarifadoList = [];
    render();
    el('#status-area-task').textContent = 'Todos os dados foram apagados.';
  });

  // filtros
  el('#buscar-tarefas').addEventListener('input', render);
  el('#buscar-os').addEventListener('input', render);

  // inicialização
  (async ()=>{
    await requestPermission();
    await loadAllData();
  })();
</script>
</body>
</html>