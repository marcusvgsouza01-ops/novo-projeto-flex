<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const API_URL = 'https://stflex-app-consulta.onrender.com';
  const API_TASKS = `${API_URL}/api/tasks`;
  const API_OS = `${API_URL}/api/os`;
  const API_ALMOXARIFADO = `${API_URL}/api/almoxarifado`;

  let tarefas = [];
  let osList = [];
  let almoxarifadoList = [];

  function el(sel){return document.querySelector(sel)}
  function formatDate(iso){ 
      if(!iso) return ''; 
      const d=new Date(iso); 
      return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); 
  }

  // render tabela de tarefas
  function renderTasksTable(tbodySel, list) {
    const tbody = el(tbodySel);
    tbody.innerHTML = '';
    if (list.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-white text-center">Sem tarefas.</td></tr>';
      return;
    }
    list.forEach(t => {
      const tr = document.createElement('tr');
      
      let prioridadeBadgeClass = 'badge bg-secondary';
      if (t.prioridade === 'baixa') {
          prioridadeBadgeClass = 'badge badge-prioridade-baixa';
      } else if (t.prioridade === 'media') {
          prioridadeBadgeClass = 'badge badge-prioridade-media';
      } else if (t.prioridade === 'alta') {
          prioridadeBadgeClass = 'badge badge-prioridade-alta';
      }
      const concluidaClass = t.concluida ? 'concluida' : '';

      tr.innerHTML = `
        <td class="${concluidaClass}">${t.titulo}</td>
        <td class="${concluidaClass}">${formatDate(t.quando)}</td>
        <td><span class="${prioridadeBadgeClass}">${t.prioridade}</span></td>
        <td>
          <button class="btn btn-sm btn-link text-white text-decoration-none" data-id="${t.id}" data-action="toggle-concluida">
              ${t.concluida ? 'Reabrir' : 'Concluir'}
          </button>
        </td>
        <td>
          <button class="btn btn-sm btn-outline-secondary" data-id="${t.id}" data-action="editar-task"><i class="bi bi-pencil-square"></i></button>
          <button class="btn btn-sm btn-outline-danger" data-id="${t.id}" data-action="excluir-task"><i class="bi bi-trash3-fill"></i></button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // render tabela de O.S.
  function renderOSTable(tbodySel, list) {
    const tbody = el(tbodySel);
    tbody.innerHTML = '';
    if (list.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-white text-center">Sem O.S. Liberadas.</td></tr>';
      return;
    }
    list.forEach(os => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${os.numero_os}</td>
        <td>${os.cliente}</td>
        <td>${os.tecnico || 'N/A'}</td>
        <td>${os.status}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary" data-id="${os.id}" data-action="editar-os"><i class="bi bi-pencil-square"></i></button>
          <button class="btn btn-sm btn-outline-danger" data-id="${os.id}" data-action="excluir-os"><i class="bi bi-trash3-fill"></i></button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // render tabela de Almoxarifado
  function renderAlmoxarifadoTable(tbodySel, list) {
    const tbody = el(tbodySel);
    tbody.innerHTML = '';
    if (list.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-white text-center">Nenhum item cadastrado.</td></tr>';
      return;
    }
    list.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.id}</td>
        <td>${item.item}</td>
        <td>${item.quantidade}</td>
        <td>${item.responsavel}</td>
        <td>${formatDate(item.data_registro)}</td>
        <td>
          <button class="btn btn-sm btn-outline-danger" data-id="${item.id}" data-action="excluir-almoxarifado"><i class="bi bi-trash3-fill"></i></button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // render listas
  function render() {
    const qTarefas = el('#buscar-tarefas').value.trim().toLowerCase();
    const qOS = el('#buscar-os').value.trim().toLowerCase();

    const pendentesTarefas = tarefas.filter(t => !t.concluida && (!qTarefas || t.titulo.toLowerCase().includes(qTarefas)))
      .sort((a, b) => new Date(a.quando) - new Date(b.quando));
    
    const concluidas = tarefas.filter(t => t.concluida)
      .sort((a, b) => new Date(a.quando) - new Date(b.quando));

    const osFiltradas = osList.filter(os => !qOS || os.numero_os.toLowerCase().includes(qOS));

    renderTasksTable('#lista-tarefas', pendentesTarefas);
    renderTasksTable('#lista-tarefas-concluidas', concluidas);
    renderOSTable('#lista-os', osFiltradas);
    renderAlmoxarifadoTable('#lista-almoxarifado', almoxarifadoList);
  }

  // API calls
  async function loadAllData(){
    try{
      const [resTasks, resOS, resAlmoxarifado] = await Promise.all([
        fetch(API_TASKS),
        fetch(API_OS),
        fetch(API_ALMOXARIFADO)
      ]);
      
      tarefas = await resTasks.json();
      osList = await resOS.json();
      almoxarifadoList = await resAlmoxarifado.json();
      
      render();
      scheduleAllNotifications();
    }catch(err){
      console.error(err);
    }
  }

  async function createTask(payload){
    const res = await fetch(API_TASKS, {
      method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function updateTask(id, payload){
    const res = await fetch(`${API_TASKS}/${id}`, {
      method:'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function deleteTask(id){
    await fetch(`${API_TASKS}/${id}`, { method:'DELETE' });
  }

  async function createOS(payload){
    const res = await fetch(API_OS, {
      method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function updateOS(id, payload){
    const res = await fetch(`${API_OS}/${id}`, {
      method:'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function deleteOS(id){
    await fetch(`${API_OS}/${id}`, { method:'DELETE' });
  }

  async function createAlmoxarifadoItem(payload){
    const res = await fetch(API_ALMOXARIFADO, {
      method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function deleteAlmoxarifadoItem(id){
    await fetch(`${API_ALMOXARIFADO}/${id}`, { method:'DELETE' });
  }

  // notifications
  async function requestPermission(){
    if('Notification' in window && Notification.permission !== 'granted'){
      await Notification.requestPermission();
    }
  }

  function scheduleNotification(t){
    if(!t.notificar) return;
    try{
      const when = new Date(t.quando).getTime() - (t.antecedencia||0)*60000;
      const delay = when - Date.now();
      if(delay > 0){
        setTimeout(()=>{
          if(Notification.permission === 'granted'){
            new Notification('Lembrete: ' + t.titulo, { body: t.descricao || formatDate(t.quando) });
          } else {
            console.log('Notificação não permitida.');
          }
        }, delay);
      }
    }catch(e){ console.error('Erro ao agendar notificação', e); }
  }

  function scheduleAllNotifications(){
    tarefas.forEach(scheduleNotification);
  }

  // form submits
  el('#task-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      titulo: el('#titulo').value.trim(),
      quando: el('#quando').value,
      antecedencia: Number(el('#antecedencia').value),
      prioridade: el('#prioridade').value,
      descricao: el('#descricao').value.trim(),
      notificar: el('#notificar').checked ? 1 : 0
    };
    el('#status-area-task').textContent = 'Salvando...';
    try{
      const created = await createTask(payload);
      tarefas.push(created);
      render();
      scheduleNotification(created);
      el('#status-area-task').textContent = 'Tarefa salva.';
      e.target.reset();
    }catch(err){
      console.error(err);
      el('#status-area-task').textContent = 'Erro ao salvar.';
    }
  });

  el('#os-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      numero_os: el('#numero_os').value.trim(),
      cliente: el('#cliente').value.trim(),
      tecnico: el('#tecnico').value.trim(),
      descricao: el('#descricao_os').value.trim()
    };
    el('#status-area-os').textContent = 'Salvando O.S...';
    try{
      const created = await createOS(payload);
      osList.push(created);
      render();
      el('#status-area-os').textContent = 'O.S. salva.';
      e.target.reset();
    }catch(err){
      console.error(err);
      el('#status-area-os').textContent = 'Erro ao salvar O.S.';
    }
  });

  el('#form-almoxarifado').addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = {
        item: el('#item-almoxarifado').value.trim(),
        quantidade: Number(el('#quantidade-almoxarifado').value),
        responsavel: el('#responsavel-almoxarifado').value.trim()
    };
    try {
        const created = await createAlmoxarifadoItem(payload);
        almoxarifadoList.push(created);
        render();
        e.target.reset();
    } catch (err) {
        console.error('Erro ao salvar item do almoxarifado:', err);
    }
  });

  // delegação de eventos para ações
  document.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button[data-action]');
    if(!btn) return;
    const id = btn.getAttribute('data-id');
    const action = btn.getAttribute('data-action');
    
    if(action === 'toggle-concluida'){
      const t = tarefas.find(x=>String(x.id) === String(id));
      if (t) {
          const payload = { ...t, concluida: t.concluida ? 0 : 1 }; 
          const updated = await updateTask(id, payload);
          tarefas = tarefas.map(x => x.id === updated.id ? updated : x);
          render();
      }
    } else if(action === 'editar-task'){
      const t = tarefas.find(x=>String(x.id) === String(id));
      if(!t) return;
      el('#nova-tarefa-tab').click();
      el('#titulo').value = t.titulo;
      const dt = new Date(t.quando);
      const pad = n=>String(n).padStart(2,'0');
      const yyyy = dt.getFullYear();
      const mm = pad(dt.getMonth()+1);
      const dd = pad(dt.getDate());
      const hh = pad(dt.getHours());
      const min = pad(dt.getMinutes());
      el('#quando').value = `${yyyy}-${mm}-${dd}T${hh}:${min}`;
      el('#antecedencia').value = t.antecedencia || 0;
      el('#prioridade').value = t.prioridade || 'media';
      el('#descricao').value = t.descricao || '';
      el('#notificar').checked = !!t.notificar;

      const form = el('#task-form');
      const originalSubmitHandler = form.onsubmit; 
      
      form.onsubmit = async (ev)=>{
        ev.preventDefault();
        const updatedPayload = {
          titulo: el('#titulo').value.trim(),
          quando: el('#quando').value,
          antecedencia: Number(el('#antecedencia').value),
          prioridade: el('#prioridade').value,
          descricao: el('#descricao').value.trim(),
          notificar: el('#notificar').checked ? 1 : 0,
          concluida: t.concluida ? 1 : 0
        };
        const updated = await updateTask(id, updatedPayload);
        tarefas = tarefas.map(x=> x.id===updated.id?updated:x);
        render();
        scheduleAllNotifications();
        el('#status-area-task').textContent = 'Atualizado.';
        form.onsubmit = originalSubmitHandler; 
        form.reset();
      };
    } else if(action === 'excluir-task'){
      if(!confirm('Excluir essa tarefa?')) return;
      await deleteTask(id);
      tarefas = tarefas.filter(x=> String(x.id) !== String(id));
      render();
    } else if(action === 'editar-os'){
      const os = osList.find(x => String(x.id) === String(id));
      if (!os) return;
      el('#nova-os-tab').click();
      el('#numero_os').value = os.numero_os;
      el('#cliente').value = os.cliente;
      el('#tecnico').value = os.tecnico;
      el('#descricao_os').value = os.descricao;
      
      const form = el('#os-form');
      const originalSubmitHandler = form.onsubmit;
      
      form.onsubmit = async (ev) => {
        ev.preventDefault();
        const updatedPayload = {
          numero_os: el('#numero_os').value.trim(),
          cliente: el('#cliente').value.trim(),
          tecnico: el('#tecnico').value.trim(),
          descricao: el('#descricao_os').value.trim(),
          status: os.status 
        };
        const updated = await updateOS(id, updatedPayload);
        osList = osList.map(x => x.id === updated.id ? updated : x);
        render();
        el('#status-area-os').textContent = 'O.S. atualizada.';
        form.onsubmit = originalSubmitHandler;
        form.reset();
      };
    } else if(action === 'excluir-os'){
      if(!confirm('Excluir essa O.S.?')) return;
      await deleteOS(id);
      osList = osList.filter(x=> String(x.id) !== String(id));
      render();
    } else if (action === 'excluir-almoxarifado') {
      if (!confirm('Excluir este item do almoxarifado?')) return;
      await deleteAlmoxarifadoItem(id);
      almoxarifadoList = almoxarifadoList.filter(x => String(x.id) !== String(id));
      render();
    }
  });

  // exportar / limpar
  el('#exportar').addEventListener('click', ()=>{
    const data = { tarefas, os: osList, almoxarifado: almoxarifadoList };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'dados_agenda.json';
    a.click();
  });

  el('#apagarTudo').addEventListener('click', async ()=>{
    if(!confirm('Apagar todos os dados do servidor? Esta ação é irreversível.')) return;
    for(const t of tarefas){ await deleteTask(t.id); }
    for(const os of osList){ await deleteOS(os.id); }
    for(const item of almoxarifadoList){ await deleteAlmoxarifadoItem(item.id); }
    tarefas = [];
    osList = [];
    almoxarifadoList = [];
    render();
    el('#status-area-task').textContent = 'Todos os dados foram apagados.';
  });

  // filtros
  el('#buscar-tarefas').addEventListener('input', render);
  el('#buscar-os').addEventListener('input', render);

  // inicialização
  (async ()=>{
    await requestPermission();
    await loadAllData();
  })();
</script>
</body>
</html>