<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Almoxarifado - Grupo ST Comunicaçao Integrada</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <style>
    :root {
      --cor-fundo: #2c3e50;
      --cor-card: #34495e;
      --cor-borda: #46607a;
      --cor-texto: #ecf0f1;
      --cor-destaque: #3498db;
      --cor-sucesso: #2ecc71;
      --cor-aviso: #f1c40f;
      --cor-perigo: #e74c4c;
    }
    body {
      background-color: var(--cor-fundo);
      color: var(--cor-texto);
    }
    .card {
      background-color: var(--cor-card);
      border: 1px solid var(--cor-borda);
    }
    .card-title, .form-label, .table-dark thead th {
      color: var(--cor-texto) !important;
    }
    .form-control, .form-select {
      background-color: var(--cor-card);
      border: 1px solid var(--cor-borda);
      color: var(--cor-texto);
    }
    .form-control::placeholder {
      color: #bdc3c7;
    }
    .table-dark thead th {
      background-color: var(--cor-card);
      border-color: var(--cor-borda);
    }
    .table-dark tbody tr {
      border-color: var(--cor-borda);
    }
    .nav-tabs .nav-link {
      color: var(--cor-texto);
      border: 1px solid transparent;
      border-bottom: 1px solid var(--cor-borda);
      background-color: var(--cor-fundo);
    }
    .nav-tabs .nav-link.active {
      background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
      color: var(--cor-destaque);
      border-color: var(--cor-borda);
      border-bottom-color: transparent;
    }
    .btn-primary {
      background-color: var(--cor-destaque);
      border-color: var(--cor-destaque);
    }
    .btn-primary:hover {
      background-color: #2980b9;
      border-color: #2980b9;
    }
    .concluida {
      text-decoration: line-through;
      color: #95a5a6 !important;
    }
    .badge-prioridade-baixa { background-color: var(--cor-sucesso); }
    .badge-prioridade-media { background-color: var(--cor-aviso); color: #000; }
    .badge-prioridade-alta { background-color: var(--cor-perigo); }
    .navbar {
      background-color: var(--cor-card);
      border-bottom: 1px solid var(--cor-borda);
    }
    .navbar-brand {
      color: var(--cor-texto) !important;
    }
    .btn-outline-secondary {
      color: var(--cor-texto);
      border-color: var(--cor-borda);
    }
    .btn-outline-danger {
      color: var(--cor-perigo);
      border-color: var(--cor-perigo);
    }
    .btn-outline-success {
      color: var(--cor-sucesso);
      border-color: var(--cor-sucesso);
    }
    #userIdDisplay {
        font-size: 0.8rem;
        color: #7f8c8d;
        word-break: break-all;
    }
    .text-center-btn {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
        margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  
  <div class="container mt-4">
    <div class="card p-4">
      <div class="d-flex justify-content-center align-items-center mb-4">
        <img src="/images/image_64f7fe.png" alt="Logo da Empresa" style="max-height: 120px;">
      </div>
      <h1 class="card-title text-center p-3">Almoxarifado - Grupo ST Comunicaçao Integrada</h1>
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="objetivos-tab" data-bs-toggle="tab" href="#objetivos" role="tab" aria-controls="objetivos" aria-selected="true">Objetivos</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="requisicoes-tab" data-bs-toggle="tab" href="#requisicoes" role="tab" aria-controls="requisicoes" aria-selected="false">Requisições de Materiais</a>
        </li>
      </ul>

      <div class="tab-content mt-3" id="myTabContent">
        <div class="tab-pane fade show active" id="objetivos" role="tabpanel" aria-labelledby="objetivos-tab">
            <h5 class="text-white">Prioridades e Objetivos</h5>
            <div class="table-responsive">
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Detalhes</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody id="prioridadeTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="tab-pane fade" id="requisicoes" role="tabpanel" aria-labelledby="requisicoes-tab">
            <h5 class="text-white">Requisições de Materiais</h5>
            <div class="table-responsive">
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Quantidade</th>
                            <th>Requisitante</th>
                            <th>Status</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody id="requisicoesTableBody">
                    </tbody>
                </table>
            </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const auth = getAuth(initializeApp(firebaseConfig));
    const db = getFirestore(auth.app);
    let userId;

    document.addEventListener('DOMContentLoaded', async () => {
        const userRole = sessionStorage.getItem('userRole');
        if (!userRole || userRole !== 'almoxarifado123') {
            window.location.href = 'login.html';
            return;
        }

        if (typeof __initial_auth_token !== 'undefined') {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
        
        userId = auth.currentUser?.uid || crypto.randomUUID();

        // Ouve as prioridades em tempo real da página ADM
        const prioridadeTableBody = document.getElementById('prioridadeTableBody');
        const prioridadesRef = collection(db, `artifacts/${appId}/public/data/prioridades`);
        
        onSnapshot(prioridadesRef, (snapshot) => {
            prioridadeTableBody.innerHTML = '';
            snapshot.forEach((doc) => {
                const data = doc.data();
                const row = document.createElement('tr');
                let detailsHtml = '';

                if (data.tipo === 'os') {
                    detailsHtml = `
                        <strong>O.S.:</strong> ${data.numeroOS}<br>
                        <strong>Cliente:</strong> ${data.nomeCliente}
                    `;
                } else if (data.tipo === 'producao') {
                    detailsHtml = `
                        <strong>Setores:</strong> ${data.setoresEnvolvidos}<br>
                        <strong>Pedidos:</strong> ${data.pedidosPrioridade}
                    `;
                }

                row.innerHTML = `
                    <td>${data.tipo === 'os' ? 'Prioridade O.S.' : 'Prioridade Produção'}</td>
                    <td>${detailsHtml}</td>
                    <td>${data.timestamp.toDate().toLocaleString('pt-BR')}</td>
                `;
                prioridadeTableBody.prepend(row);
            });
        });

        // Ouve as requisições de materiais dos outros setores
        const requisicoesTableBody = document.getElementById('requisicoesTableBody');
        const requisicoesRef = collection(db, `artifacts/${appId}/public/data/almoxarifado_requisicoes`);
        
        onSnapshot(requisicoesRef, (snapshot) => {
            requisicoesTableBody.innerHTML = '';
            if (snapshot.empty) {
                requisicoesTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhuma requisição de material pendente.</td></tr>';
            } else {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = `<tr>
                        <td>${data.item}</td>
                        <td>${data.quantidade}</td>
                        <td>${data.requisitante}</td>
                        <td><span class="badge ${data.status === 'Pendente' ? 'badge-prioridade-perigo' : 'badge-prioridade-sucesso'}">${data.status}</span></td>
                        <td><button class="btn btn-sm btn-outline-success" data-id="${doc.id}">Marcar como Atendido</button></td>
                    </tr>`;
                    requisicoesTableBody.innerHTML += row;
                });
            }
        });

        // Marca uma requisição como atendida
        requisicoesTableBody.addEventListener('click', async (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.textContent === 'Marcar como Atendido') {
                const docId = e.target.getAttribute('data-id');
                try {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/almoxarifado_requisicoes`, docId), {
                        status: 'Atendido'
                    });
                } catch (error) {
                    console.error("Erro ao atualizar requisição:", error);
                }
            }
        });
    });
  </script>
</body>
</html>
