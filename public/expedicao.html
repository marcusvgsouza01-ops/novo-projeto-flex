<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expedição - Grupo ST Comunicaçao Integrada</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <style>
    :root {
      --cor-fundo: #2c3e50;
      --cor-card: #34495e;
      --cor-borda: #46607a;
      --cor-texto: #ecf0f1;
      --cor-destaque: #3498db;
      --cor-sucesso: #2ecc71;
      --cor-aviso: #f1c40f;
      --cor-perigo: #e74c4c;
    }
    body {
      background-color: var(--cor-fundo);
      color: var(--cor-texto);
    }
    .card {
      background-color: var(--cor-card);
      border: 1px solid var(--cor-borda);
    }
    .card-title, .form-label, .table-dark thead th {
      color: var(--cor-texto) !important;
    }
    .form-control, .form-select {
      background-color: var(--cor-card);
      border: 1px solid var(--cor-borda);
      color: var(--cor-texto);
    }
    .form-control::placeholder {
      color: #bdc3c7;
    }
    .table-dark thead th {
      background-color: var(--cor-card);
      border-color: var(--cor-borda);
    }
    .table-dark tbody tr {
      border-color: var(--cor-borda);
    }
    .nav-tabs .nav-link {
      color: var(--cor-texto);
      border: 1px solid transparent;
      border-bottom: 1px solid var(--cor-borda);
      background-color: var(--cor-fundo);
    }
    .nav-tabs .nav-link.active {
      background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
      color: var(--cor-destaque);
      border-color: var(--cor-borda);
      border-bottom-color: transparent;
    }
    .btn-primary {
      background-color: var(--cor-destaque);
      border-color: var(--cor-destaque);
    }
    .btn-primary:hover {
      background-color: #2980b9;
      border-color: #2980b9;
    }
    .concluida {
      text-decoration: line-through;
      color: #95a5a6 !important;
    }
    .badge-prioridade-baixa { background-color: var(--cor-sucesso); }
    .badge-prioridade-media { background-color: var(--cor-aviso); color: #000; }
    .badge-prioridade-alta { background-color: var(--cor-perigo); }
    .navbar {
      background-color: var(--cor-card);
      border-bottom: 1px solid var(--cor-borda);
    }
    .navbar-brand {
      color: var(--cor-texto) !important;
    }
    .btn-outline-secondary {
      color: var(--cor-texto);
      border-color: var(--cor-borda);
    }
    .btn-outline-danger {
      color: var(--cor-perigo);
      border-color: var(--cor-perigo);
    }
    .btn-outline-success {
      color: var(--cor-sucesso);
      border-color: var(--cor-sucesso);
    }
    #userIdDisplay {
        font-size: 0.8rem;
        color: #7f8c8d;
        word-break: break-all;
    }
    .text-center-btn {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
        margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  
  <div class="container mt-4">
    <div class="card p-4">
      <div class="d-flex justify-content-center align-items-center mb-4">
        <img src="/images/image_64f7fe.png" alt="Logo da Empresa" style="max-height: 120px;">
      </div>
      <h1 class="card-title text-center p-3">Expedição - Grupo ST Comunicaçao Integrada</h1>
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="objetivos-tab" data-bs-toggle="tab" href="#objetivos" role="tab" aria-controls="objetivos" aria-selected="true">Objetivos</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="pedidos-tab" data-bs-toggle="tab" href="#pedidos" role="tab" aria-controls="pedidos" aria-selected="false">Pedidos de Expedição</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="requisicoes-tab" data-bs-toggle="tab" href="#requisicoes" role="tab" aria-controls="requisicoes" aria-selected="false">Requisições de Materiais</a>
        </li>
      </ul>

      <div class="tab-content mt-3" id="myTabContent">
        <div class="tab-pane fade show active" id="objetivos" role="tabpanel" aria-labelledby="objetivos-tab">
            <h5 class="text-white">Prioridades e Objetivos</h5>
            <div class="table-responsive">
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Detalhes</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody id="prioridadeTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="tab-pane fade" id="pedidos" role="tabpanel" aria-labelledby="pedidos-tab">
            <h5 class="text-white">Gerenciamento de Pedidos</h5>
            <form id="pedidoForm">
                <div class="mb-3">
                    <label for="pedidoNumero" class="form-label">Número do Pedido</label>
                    <input type="text" class="form-control" id="pedidoNumero" required>
                </div>
                <div class="mb-3">
                    <label for="pedidoCliente" class="form-label">Nome do Cliente</label>
                    <input type="text" class="form-control" id="pedidoCliente" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Atualizar Status</button>
            </form>
            <div id="pedidoStatusMessage" class="mt-3 text-center"></div>
        </div>
        <div class="tab-pane fade" id="requisicoes" role="tabpanel" aria-labelledby="requisicoes-tab">
            <h5 class="text-white">Requisição de Materiais</h5>
            <form id="requisicaoForm">
                <div class="mb-3">
                    <label for="itemRequisicao" class="form-label">Item</label>
                    <input type="text" class="form-control" id="itemRequisicao" required>
                </div>
                <div class="mb-3">
                    <label for="quantidadeRequisicao" class="form-label">Quantidade</label>
                    <input type="number" class="form-control" id="quantidadeRequisicao" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Enviar Requisição</button>
            </form>
            <div id="requisicaoStatusMessage" class="mt-3 text-center"></div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const auth = getAuth(initializeApp(firebaseConfig));
    const db = getFirestore(auth.app);
    let userId;

    document.addEventListener('DOMContentLoaded', async () => {
        const userRole = sessionStorage.getItem('userRole');
        if (!userRole || userRole !== 'expedicao123') {
            window.location.href = 'login.html';
            return;
        }

        if (typeof __initial_auth_token !== 'undefined') {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
        
        userId = auth.currentUser?.uid || crypto.randomUUID();

        // Ouve as prioridades em tempo real da página ADM
        const prioridadeTableBody = document.getElementById('prioridadeTableBody');
        const prioridadesRef = collection(db, `artifacts/${appId}/public/data/prioridades`);
        
        onSnapshot(prioridadesRef, (snapshot) => {
            prioridadeTableBody.innerHTML = '';
            snapshot.forEach((doc) => {
                const data = doc.data();
                const row = document.createElement('tr');
                let detailsHtml = '';

                if (data.tipo === 'os') {
                    detailsHtml = `
                        <strong>O.S.:</strong> ${data.numeroOS}<br>
                        <strong>Cliente:</strong> ${data.nomeCliente}
                    `;
                } else if (data.tipo === 'producao') {
                    detailsHtml = `
                        <strong>Setores:</strong> ${data.setoresEnvolvidos}<br>
                        <strong>Pedidos:</strong> ${data.pedidosPrioridade}
                    `;
                }

                row.innerHTML = `
                    <td>${data.tipo === 'os' ? 'Prioridade O.S.' : 'Prioridade Produção'}</td>
                    <td>${detailsHtml}</td>
                    <td>${data.timestamp.toDate().toLocaleString('pt-BR')}</td>
                `;
                prioridadeTableBody.prepend(row);
            });
        });
        
        // Funcionalidade de gerenciar pedidos de expedição
        const pedidoForm = document.getElementById('pedidoForm');
        const pedidoStatusMessage = document.getElementById('pedidoStatusMessage');
        pedidoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const pedidoNumero = document.getElementById('pedidoNumero').value;
            const pedidoCliente = document.getElementById('pedidoCliente').value;

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/expedicao_pedidos`), {
                    pedido: pedidoNumero,
                    cliente: pedidoCliente,
                    status: 'Em Separação',
                    dataEnvio: new Date(),
                });
                pedidoStatusMessage.textContent = 'Status do pedido atualizado com sucesso!';
                pedidoStatusMessage.style.color = 'var(--cor-sucesso)';
                pedidoForm.reset();
            } catch (error) {
                console.error("Erro ao atualizar pedido:", error);
                pedidoStatusMessage.textContent = 'Erro ao atualizar pedido. Tente novamente.';
                pedidoStatusMessage.style.color = 'var(--cor-perigo)';
            }
        });

        // Funcionalidade de requisição de materiais
        const requisicaoForm = document.getElementById('requisicaoForm');
        const requisicaoStatusMessage = document.getElementById('requisicaoStatusMessage');
        requisicaoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const item = document.getElementById('itemRequisicao').value;
            const quantidade = document.getElementById('quantidadeRequisicao').value;

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/almoxarifado_requisicoes`), {
                    item,
                    quantidade,
                    status: 'Pendente',
                    requisitante: 'Expedição',
                    timestamp: new Date()
                });
                requisicaoStatusMessage.textContent = 'Requisição enviada com sucesso!';
                requisicaoStatusMessage.style.color = 'var(--cor-sucesso)';
                requisicaoForm.reset();
            } catch (error) {
                console.error("Erro ao enviar requisição:", error);
                requisicaoStatusMessage.textContent = 'Erro ao enviar requisição. Tente novamente.';
                requisicaoStatusMessage.style.color = 'var(--cor-perigo)';
            }
        });
    });
  </script>
</body>
</html>
